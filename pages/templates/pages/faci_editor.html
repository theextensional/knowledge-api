{% extends 'template.html' %}

{% block title %}
    {% if form_aim.instance.id %} <a style="text-decoration: none;" href="{% url 'faci_list' %}">ü°Ñ</a> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞ {% else %} –ù–æ–≤—ã–π —Ö–æ–ª—Å—Ç {% endif %}
{% endblock %}
{% block page_title %} –•–æ–ª—Å—Ç —Ñ–∞—Å–∏–ª–∏—Ç–∞—Ü–∏–∏ {% endblock %}

{% block content %}
    {{ members|json_script:'members_json' }}
    <style>
        .card-body form {
            position: relative;
        }
        .form_sheet {
            position: absolute;
            top: 0;
            left: 0;
            background-color: ghostwhite;
            opacity: 90%;
            width: 100%;
            height: 100%;
        }
        
        /* ListDown */
        .form_listdown {
            position: relative;
        }
        .button_ss {cursor: pointer;}
        .suggestions {
            position:absolute;
            width: calc(110% + 15px);
            background: #faf143; text-align: left;
            font-size: 10pt;
            color: #0e283c;
            z-index: 100;
        }
        .suggestions div {padding: 4px 5px 4px 5px; border-bottom: 1px solid #dfa4a4; cursor: pointer;}
        .suggestions div:hover {background:#ffe4e4;}
    </style>

    <div class="row">
        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    1. –¶–µ–ª—å
                </div>
                <div class="card-body">
                    <form id="aim_form">
                        <div class="mb-3">
                            <label for="{{ form_aim.aim_type.id_for_label }}" class="form-label">{{ form_aim.aim_type.label }}</label>
                            {{ form_aim.aim_type }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_aim.aim.id_for_label }}" class="form-label">{{ form_aim.aim.label }}</label>
                            {{ form_aim.aim }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_aim.if_not_reached.id_for_label }}" class="form-label">{{ form_aim.if_not_reached.label }}</label>
                            {{ form_aim.if_not_reached }}
                        </div>

                        <input type="button" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% if step == 1 %} –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤{% endif %}" class="form-control">
                   </form>
                </div>
            </div>
            
            <br>

            <div class="card">
                <div class="card-header">
                    2. –£—á–∞—Å—Ç–Ω–∏–∫–∏
                </div>
                <div class="card-body">
                    <form id="members_form">
                        <div id="app"></div>
                        <input type="button" value="–î–æ–±–∞–≤–∏—Ç—å" id="add_member_button" class="form-control">              
                        <div class="{% if step > 1 %}d-none {% endif %}form_sheet">–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ 1-–π —à–∞–≥</div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-sm-3">
            <div class="card">
                <div class="card-header">
                    3. –ü–æ–≤–µ—Å—Ç–∫–∞
                </div>
                <div class="card-body">
                    <form id="agenda_form">
                        <div class="{% if step > 2 %}d-none {% endif %}form_sheet">–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (2-–π —à–∞–≥)</div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-sm-3">
            <div class="card">
                <div class="card-header">
                    4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
                </div>
                <div class="card-body">
                    <form id="preparing_form">
                        <div class="mb-3">
                            <label for="{{ form_aim.dt_meeting.id_for_label }}" class="form-label">{{ form_aim.dt_meeting.label }}</label>
                            {{ form_aim.dt_meeting }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_aim.duration.id_for_label }}" class="form-label">{{ form_aim.duration.label }}</label>
                            {{ form_aim.duration }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_aim.place.id_for_label }}" class="form-label">{{ form_aim.place.label }}</label>
                            {{ form_aim.place }}
                        </div>
                        <div class="{% if step > 3 %}d-none {% endif %}form_sheet">–û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 3-–≥–æ —à–∞–≥–∞</div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <br>

    <div class="row">
        <div class="col-sm-8">
            <div class="card">
                <div class="card-header">
                    5. –ö–ª—é—á–µ–≤—ã–µ –º—ã—Å–ª–∏
                </div>
                <div class="card-body">
                    <form id="key_thoughts_form">
                        <div class="mb-3">
                            <label for="{{ form_aim.key_thoughts.id_for_label }}" class="form-label">{{ form_aim.key_thoughts.label }}</label>
                            {{ form_aim.key_thoughts }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_aim.parked_thoughts.id_for_label }}" class="form-label">{{ form_aim.parked_thoughts.label }}</label>
                            {{ form_aim.parked_thoughts }}
                        </div>
                        <div class="{% if step > 4 %}d-none {% endif %}form_sheet">–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤–æ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏ (–ø–æ—Å–ª–µ —à–∞–≥–∞ 4)</div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="card">
                <div class="card-header">
                    6. –î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
                </div>
                <div class="card-body">
                    <form id="agreements_form">
                        <div class="{% if step > 4 %}d-none {% endif %}form_sheet">–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤–æ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏ (–ø–æ—Å–ª–µ —à–∞–≥–∞ 4)</div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ListdownFieldItem = {
            props: ["key", "id", "value"],
            emits: ['change'],
            template: `<div v-on:click="$emit('change', id, value)">[[ value ]]</div>`,
        }
    
        const ListdownField = {
            props: ["id", "value", "name", "edit"],
            emits: ['search-item', 'change', 'blur', 'focus', 'update:value', 'update:id'],
            template: `
<div class="component_listdown">
    <span class="button_ss" @click="focus" :class="{'d-none': is_edit}">[[ mvalue ]]</span>
    <div class="form_listdown" :class="{'d-none': !is_edit}">
        <input type='text' v-model.trim="query" @keyup="search_item" @blur="blur" class="field_listdown">
        <div class="suggestions">
            <listdown-field-item
                @change="select_item"
                v-for="item in item_list"
                :value="item.value"
                :key="item.id"
                :id="item.id"
            ></listdown-field-item>
        </div>
        <input type="hidden" v-bind:name="name" v-model.trim="mid">
    </div>
</div>
`,
            data() {
                return {
                    mvalue: this.value,
                    query: '',
                    mid: this.id,
                    is_edit: this.edit,
                    item_list: [],
                }
            },
            methods: {
                focus(event) {
                    this.is_edit = true;
                    let self = this;
                    setTimeout(function() {
                        if (!self.query) self.query = self.mvalue;
                        self.$el.querySelector('.field_listdown').focus();
                        self.$emit('focus', self);
                    }, 20);
                },
                blur(event) {
                    let self = this;
                    setTimeout( // —á—Ç–æ–±—ã —Å–Ω–∞—á–∞–ª–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–æ —Å–æ–±—ã—Ç–∏–µ click –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
                        function() {
                            self.is_edit = false;
                            self.$emit('blur', self);
                        },
                        100,
                    );
                },
                search_item(event) {
                    this.item_list = [];
                    this.$emit('search-item', this);
                },
                select_item(item_id, item_value) {
                    this.mid = item_id;
                    this.mvalue = item_value;
                    this.$emit('update:id', item_id);
                    this.$emit('update:value', item_value);
                    if (this.$emit('change', item_id, item_value)) {
                        this.is_edit = false;
                        this.query = '';
                    }
                },
            },
            components: {
                ListdownFieldItem
            },
        }
    
        const ToggleField = {
            props: ["id", "value", "name"],
            emits: ['focus', 'blur'],
            template: `
<div>
    <span class="el_sign" @click="focus" style="cursor: pointer;" :class="{'d-none': is_edit}">[[ mvalue ]]</span>
    <input v-model.trim="mvalue" :name="name" @blur="blur" class="el_field" :class="{'d-none': !is_edit}"/>
</div>`,
            data() {
                return {mvalue: this.value, mid: this.id, previous_value: this.value, is_edit: false};
            },
            methods: {
                focus(event) {
                    this.is_edit = true;
                    let field = this.$el.querySelector('.el_field');
                    this.previous_value = this.mvalue;
                    self = this;
                    setTimeout(function() {
                        field.focus();
                        self.$emit('focus', self);
                    }, 20);
                },
                blur(event) {
                    this.is_edit = false;00
                    if (this.mid) {
                        if (this.mvalue) {
                            if (this.mvalue != this.previous_value) {
                                this.$emit('blur', this);
                            }
                        } else {
                            this.mvalue = this.previous_value;
                        }
                    } else {
                        if (!this.mvalue) {
                            this.mvalue = this.previous_value;
                        }
                    }
                },
            },
        }

        const MemberItem = {
            props: ["member"],
            template: `
<tr>
    <td>
        <listdown-field
              @search-item="search_user"
              @change="select_user"
              @blur="blur_selecting_user"
              v-model:value="member.invited"
              :edit="member.edit"
              name="invited"
        ></listdown-field>
    </td>
    <td>
        <toggle-field
           @blur="blur_input_for_what"
          :value="member.for_what"
          :id="member.id"
          name="for_what"
        ></toggle-field>
    </td>
    <td>[[ member.inviting ]]</td>
</tr>`,
            components: {
                ListdownField, ToggleField
            },
            methods: {
                save_member() {
                    $.ajax({
                        url: 'member/' + this.member.invited + '/',
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        dataType: 'json',
                        data: {for_what: this.member.for_what},
                        success: function(result) {
                            console.log(result);
                        },
                        error: function(jqxhr, a, b) {
                            console.log('error');
                            console.log(jqxhr.responseText);
                        },
                        method: "post"
                    });
                },
                search_user(component) {
                    $.ajax({
                        url: "{% url 'search_user' %}",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        dataType: 'json',
                        data: {search_string: component.query},
                        success: function(result) {
                            let username;
                            for (username of result) {
                                component.item_list.push({'id': username, 'value': username});
                            }
                            if (component.item_list.length == 0) {
                                component.item_list.push({'id': null, 'value': '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'});
                            }
                        },
                        error: function(jqxhr, a, b) {
                            console.log('error');
                            console.log(jqxhr.responseText);
                        },
                        method: "post"
                    });
                },

                select_user(id, value) {
                    console.log(value);
                    this.save_member();
                    return true;
                },
                blur_selecting_user(component) {
                    console.log(component);
                    console.log(this.member);
                },
                blur_input_for_what(component) {
                    console.log(this.member);
                    this.save_member();
                },

            },
        }

        const { createApp } = Vue

        var app = createApp({
            template: `
<table>
    <tr>
        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
        <th>–í –∫–∞–∫–æ–º –≤–æ–ø—Ä–æ—Å–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω</th>
        <th>–ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª</th>
    </tr>
    <member-item
        v-for="member in member_list"
        :member="member"
    ></member-item>
</table>`,
            data() {
                return {
                    //member_list: [{'id': '1', 'invited': 'user1', 'inviting': 'test uswr', 'for_what': '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–≤–∞–Ω—Ç–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º', 'edit': false}],
                    member_list: JSON.parse(document.getElementById('members_json').textContent),
                }
            },
            methods: {
                add_member(event) {
                    this.member_list.push({'id': '', 'invited': '', 'inviting': '{{ request.user.username }}', 'for_what': '—Ü–µ–ª—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è?', 'edit': true});
                    setTimeout(function() {
                        //click_on_last('.app_name');
                    }, 20);
                },
            },
            components: {
                MemberItem
            },
            compilerOptions: {
                delimiters: ["[[", "]]"],
            },
        });
        app.config.compilerOptions.delimiters = [ '[[', ']]' ];
        var member_list = app.mount('#app');
    
        $("#add_member_button").click(member_list.add_member);
    </script>

    <script>
        function save_form_aim(event) {
            $.ajax({
                url: "",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                dataType: 'json',
                data: $(event.target.form).serialize(),
                success: function(result) {
                    if (result['id']) {
                        try {
                            history.pushState(null, null, location.href.replace('/new', '/'+result['id']));
                            $('#members_form .form_sheet')[0].classList.add('d-none');
                        } catch(e) {}
                    }
                },
                error: function(jqxhr, a, b) {
                    console.log('error');
                    console.log(jqxhr.responseText);
                },
                method: "post"
            });
        }
        
        $('#aim_form').change(save_form_aim);
    </script>
{% endblock %}